name: deployer
on:
  pull_request_target:
    types:
      - closed
env:
  QUATERNION: ${{secrets.QAK}}
  QLOCATION: ${{secrets.QCOOR}}

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@v2
    
    - name: checkout main    
      uses: actions/checkout@v3
      with:
        ref: main 
    
    - name: generate server access
      run: |
          echo "$QUATERNION" >> $HOME/.quaternion/qak.pem
          chmod 400 $HOME/.quaternion/qak.pem

    - name: entity deployer
      run: |
        ls -lh $HOME/.quaternion/qak.pem
        echo $USER
        sudo chown $USER:$USER $HOME/.quaternion/qak.pem
        sudo chown $USER:$USER $HOME/.quaternion
        ls -lh $HOME/.quaternion
        ls -lh $HOME
        scp -i $HOME/.quaternion/qak.pem -o StrictHostKeyChecking=no decoy.py $QLOCATION:~/
